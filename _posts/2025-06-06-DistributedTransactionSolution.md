---
title: 分布式事务解决方案
date: 2025-06-06 14:59:00 +0800
categories: [分布式事务]
tags: [分布式事务,XA,AT]
---





## 两阶段提交2PC（Two-Phase Commit）

两阶段提交是强一致性的，同步阻塞。将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（commit phase）。类似于Seata的XA模式。各分支事务执行完后不会马上提交，而是像协调者报告事务可以提交，如果全部分支事务都报告可以提交，才会提交。

![image-20250606090751358](assets/2025-06-06-DistributedTransactionSolution.assets/image-20250606090751358.png)

弊端：

- 需要本地数据库支持XA协议
- 数据不一致：在事务管理器向所有服务发送提交事务Commit阶段时，某些参与者可能发生网络抖动，无法正常接收到Commit请求，从而导致每个参与者的数据不一致
- 单点故障：如果协调者故障，参与者就无法提交事务
- 性能问题：同步阻塞

> AT模式
>
> Seata主推的是AT模式，AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷
>
> ![image-20250606090936154](assets/2025-06-06-DistributedTransactionSolution.assets/image-20250606090936154.png)
>
> 阶段一`RM`的工作：
>
> - 注册分支事务
> - 记录undo-log（数据快照）
> - 执行业务sql并提交
> - 报告事务状态
>
> 阶段二提交时`RM`的工作：
>
> - 删除undo-log即可
>
> 阶段二回滚时`RM`的工作：
>
> - 根据undo-log恢复数据到更新前
>
> > `AT`模式与`XA`模式最大的区别是什么？
> >
> > `XA`模式一阶段不提交事务，锁定资源；`AT`模式一阶段直接提交，不锁定资源。
> >
> > `XA`模式依赖数据库机制实现回滚；`AT`模式利用数据快照实现数据回滚。
> >
> > `XA`模式强一致；`AT`模式最终一致

## 三阶段提交3PC

3PC 的出现是为了解决 2PC 的一些问题，相比于 2PC 它在参与者中也引入了**超时机制**，并且新增了一个阶段使得参与者可以利用这个阶段统一各自的状态。

3PC 包含了三个阶段，分别是准备阶段、预提交阶段和提交阶段，对应的英文就是：CanCommit、PreCommit 和 DoCommit。

看起来是把2PC的提交阶段变成了预提交阶段和提交阶段，但是 3PC的准备阶段协调者只是询问参与者的自身状况，比如你现在还好吗？负载重不重？这类的。（避免在资源不可用的情况下依旧锁定资源）

而预提交阶段就是和 2PC 的准备阶段一样，除了事务的提交该做的都做了。

提交阶段和 2PC 的一样，如图所示。

<img src="assets/2025-06-06-DistributedTransactionSolution.assets/image-20250606090535920.png" alt="image-20250606090535920" style="zoom:67%;" />

## 可靠消息最终一致性

事务发起者将“要发送的消息”存入本地消息表，与业务操作放在一个本地事务中；事务发起者的本地事务执行完成之后发送MQ消息，消息表是为了做MQ补偿。消费方收到消息后执行操作，失败可重试或补偿。

最终一致性。注意事务参与方要做幂等校验（因为可能MQ重复发送）。

> 不能把消息发送和执行本地事务写在一个事务里面：
>
> ```
> begin transaction；
> //1.发送MQ
> //2.数据库操作
> commit transation;
> ```
>
> 这样可能出现MQ成功而数据库操作失败
>
> 如果是这样：
>
> ```
> begin transaction；
> //1.数据库操作
> //2.发送MQ
> commit transation;
> ```
>
> 这种情况下貌似没有问题，如果发送MQ消息失败，就会抛出异常，导致数据库事务回滚。但如果是超时异常（MQ投递成功而发送方以为投递失败），数据库回滚，但MQ其实已经正常发送了，同样会导致不一致。



## 尽最大努力通知

<img src="assets/2025-06-06-DistributedTransactionSolution.assets/image-20250606090549278.png" alt="image-20250606090549278" style="zoom:67%;" />

发送方尽最大努力发送，例如采用重试机制，关键在于消息接收方如果接收不到信息会主动查询结果







参考：

[【Seata】Seata AT和XA模式联系和区别_seata的at和xt区别-CSDN博客](https://blog.csdn.net/m0_45406092/article/details/121421147)

https://blog.csdn.net/fengyuyeguirenenen/article/details/140152184
