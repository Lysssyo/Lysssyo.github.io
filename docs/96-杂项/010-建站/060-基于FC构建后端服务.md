# åŸºäºäº‘å‡½æ•° (FC) æ„å»ºåç«¯æœåŠ¡

## 1. èƒŒæ™¯ä¸ç—›ç‚¹

åœ¨åŸºäº VitePress æˆ–å…¶ä»–é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼ˆSSGï¼‰æ„å»ºçš„åšå®¢ä¸­ï¼Œé¡µé¢æ˜¯çº¯é™æ€ HTML/JSï¼Œéƒ¨ç½²åœ¨ GitHub Pages ç­‰å…¬å¼€ç¯å¢ƒã€‚

å¦‚æœæˆ‘ä»¬éœ€è¦å±•ç¤º**ç§æœ‰å†…å®¹**ï¼ˆå¦‚ä¸ªäººæ—¥è®°ã€æ•æ„Ÿç¬”è®°ï¼‰ï¼Œé¢ä¸´ä»¥ä¸‹çŸ›ç›¾ï¼š
1.  **æ•°æ®å®‰å…¨æ€§**ï¼šä¸èƒ½ç›´æ¥å°†ç§æœ‰ `.md` æ–‡ä»¶ç¼–è¯‘åˆ°é™æ€èµ„æºä¸­ï¼Œå¦åˆ™ä»»ä½•äººéƒ½èƒ½é€šè¿‡æŸ¥çœ‹æºç æˆ–ç›®å½•æ‰«æçœ‹åˆ°ã€‚
2.  **å¯†é’¥å®‰å…¨æ€§**ï¼šä¸èƒ½åœ¨å‰ç«¯ä»£ç ä¸­ç›´æ¥ä½¿ç”¨ GitHub Personal Access Token (PAT) æ¥è¯·æ±‚ç§æœ‰ä»“åº“ï¼Œå› ä¸ºå‰ç«¯ä»£ç æ˜¯å…¬å¼€çš„ï¼ŒToken ä¸€æ—¦æ³„éœ²ï¼Œä»“åº“å°†å®Œå…¨æš´éœ²ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼•å…¥ä¸€ä¸ª**Serverless åç«¯ï¼ˆé˜¿é‡Œäº‘å‡½æ•°è®¡ç®— FCï¼‰**ä½œä¸ºâ€œä¸­é—´äººä»£ç†â€ã€‚
- å‰ç«¯åªæŒæœ‰è®¿é—® FC çš„æ™®é€šå¯†ç ï¼ˆå³ä¾¿æ˜¯æ³„éœ²ä¹Ÿåªæ˜¯æ³„éœ²äº†æŸ¥çœ‹æƒï¼Œä¸å½±å“ä»“åº“å®‰å…¨ï¼‰ã€‚
- FC åç«¯æŒæœ‰çœŸæ­£çš„ GitHub Tokenï¼ˆå­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œä¸å¯¹å¤–æš´éœ²ï¼‰ã€‚
- FC è´Ÿè´£é‰´æƒã€è½¬å‘è¯·æ±‚å¹¶å¤„ç†å“åº”ã€‚

## 2. æ ¸å¿ƒäº¤äº’æµç¨‹

å‰ç«¯ï¼ˆVueç»„ä»¶ï¼‰ä¸åç«¯ï¼ˆNode.js FCï¼‰é€šè¿‡ HTTP åè®®è¿›è¡Œäº¤äº’ã€‚æ ¸å¿ƒé€»è¾‘åˆ†ä¸ºä¸¤æ­¥ï¼š**èº«ä»½éªŒè¯**ä¸**æ•°æ®ä»£ç†**ã€‚

### äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant FE as å‰ç«¯ (PrivateVault.vue)
    participant FC as é˜¿é‡Œäº‘å‡½æ•°è®¡ç®— (Node.js)
    participant GH as GitHub API

    Note over User, FE: é˜¶æ®µä¸€ï¼šè§£é” (Action: list)
    User->>FE: è¾“å…¥è®¿é—®å¯†ç å¹¶ç‚¹å‡»è§£é”
    FE->>FC: POST / (body: {password, action: 'list'})
    
    rect rgb(240, 248, 255)
        Note right of FE: FC å†…éƒ¨å¤„ç†
        FC->>FC: 1. è§£æ Event è·å– Body
        FC->>FC: 2. æ ¡éªŒ password == process.env.ACCESS_PASSWORD
        FC->>GH: 3. æºå¸¦ GITHUB_TOKEN è¯·æ±‚ /git/trees/main
    end
    
    GH-->>FC: è¿”å›æ–‡ä»¶æ ‘ JSON
    FC-->>FE: è¿”å›è¿‡æ»¤åçš„ .md æ–‡ä»¶åˆ—è¡¨
    FE-->>User: æ¸²æŸ“å·¦ä¾§ç›®å½•æ ‘

    Note over User, FE: é˜¶æ®µäºŒï¼šè¯»å– (Action: content)
    User->>FE: ç‚¹å‡»æŸä¸ªæ–‡ä»¶
    FE->>FC: POST / (body: {password, action: 'content', path: 'xxx.md'})
    
    rect rgb(240, 248, 255)
        FC->>FC: æ ¡éªŒå¯†ç 
        FC->>GH: æºå¸¦ Token è¯·æ±‚ /contents/xxx.md
    end
    
    GH-->>FC: è¿”å› { content: "Base64ä¸²", ... }
    FC-->>FE: é€ä¼  GitHub å“åº”
    FE->>FE: Base64 è§£ç  -> UTF-8 -> Markdown æ¸²æŸ“
    FE-->>User: å±•ç¤ºæ¸²æŸ“åçš„ HTML
```

## 3. å‰ç«¯å®ç°åŸç† (Client)

å‰ç«¯ä¸»è¦é€šè¿‡ `fetch` API å‘èµ· `POST` è¯·æ±‚ã€‚

**è¯·æ±‚ç‰¹å¾ï¼š**
*   **URL**: é˜¿é‡Œäº‘ FC çš„ HTTP è§¦å‘å™¨åœ°å€ã€‚
*   **Method**: `POST` (ä¸ºäº†å°†å¯†ç æ”¾åœ¨ Body ä¸­ï¼Œé¿å… URL å‚æ•°æ³„éœ²)ã€‚
*   **Payload**: ç»Ÿä¸€ JSON æ ¼å¼ã€‚

```typescript
// ä¼ªä»£ç ç¤ºä¾‹
const payload = {
  password: "ç”¨æˆ·è¾“å…¥çš„å£ä»¤", // ç”¨äº FC å±‚é¢çš„é‰´æƒ
  action: "list" | "content", // å‘Šè¯‰åç«¯æˆ‘è¦å¹²å˜›
  path: "docs/Private/secret.md" // å¦‚æœæ˜¯ content æ“ä½œï¼Œéœ€è¦ä¼ è·¯å¾„
};

const res = await fetch(API_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
});
```

**å“åº”å¤„ç†ï¼š**
GitHub API è¿”å›çš„æ–‡ä»¶å†…å®¹æ˜¯ **Base64** ç¼–ç çš„ï¼ˆä¸ºäº†æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œå‰ç«¯æ‹¿åˆ°åéœ€è¦è§£ç ï¼š

```typescript
// 1. è·å– Base64 å­—ç¬¦ä¸²
const contentBase64 = data.content.replace(/\s/g, '');
// 2. è§£ç ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²
const binaryString = window.atob(contentBase64);
// 3. è½¬ä¸º UTF-8 æ–‡æœ¬ (è§£å†³ä¸­æ–‡ä¹±ç å…³é”®)
const bytes = new Uint8Array(binaryString.length);
for (let i = 0; i < binaryString.length; i++) {
  bytes[i] = binaryString.charCodeAt(i);
}
const decoder = new TextDecoder('utf-8');
const markdownText = decoder.decode(bytes);
```

## 4. åç«¯å®ç°åŸç† (Serverless)

é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—ï¼ˆFCï¼‰æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨çš„æ–¹å¼è°ƒç”¨ `handler` å‡½æ•°ã€‚

### 4.1 è¯·æ±‚çš„å°è£… (Event Object)

å½“ä½¿ç”¨ HTTP è§¦å‘å™¨æ—¶ï¼Œ**FC ä¼šå°†æ ‡å‡†çš„ HTTP è¯·æ±‚å°è£…æˆä¸€ä¸ª `event` buffer**ã€‚æˆ‘ä»¬éœ€è¦è§£æå®ƒï¼š

```javascript
exports.handler = (event, context, callback) => {
  // 1. event æ˜¯ä¸€ä¸ª Bufferï¼Œéœ€è¦è½¬å­—ç¬¦ä¸²å†è½¬ JSON
  let eventObj = JSON.parse(event.toString());
  
  // 2. è·å– HTTP Method
  const method = eventObj.requestContext?.http?.method;
  
  // 3. å¤„ç† Body (å¯èƒ½è¢« FC è‡ªåŠ¨ Base64 ç¼–ç )
  let rawBody = eventObj.body;
  if (eventObj.isBase64Encoded) {
    rawBody = Buffer.from(rawBody, 'base64').toString();
  }
  const body = JSON.parse(rawBody);
  
  // ... åç»­é€»è¾‘
}
```

> [!IMPORTANT] FCä¼šæŠŠæ ‡å‡†çš„ HTTP è¯·æ±‚å°è£…æˆä¸€ä¸ª `event` buffer**
> æ³¨æ„åˆ°FCçš„å…¥å£æ˜¯`exports.handler = (event, context, callback)`ï¼Œ`event`å³ä¸ºå°è£…åçš„HTTPè¯·æ±‚ï¼ˆå…·ä½“ç»“æ„è§[Event ç»“æ„](060-åŸºäºFCæ„å»ºåç«¯æœåŠ¡.md#Event%20ç»“æ„)ï¼‰
> æ­¤å¤–ï¼Œé˜¿é‡Œäº‘FCçš„ã€æµ‹è¯•å‡½æ•°ã€‘å®é™…ä¸Šæ˜¯ mock `event`çš„å€¼
### 4.2 å“åº”çš„å°è£… (Response Object)

å‡½æ•°è®¡ç®—è¦æ±‚è¿”å›å€¼å¿…é¡»ç¬¦åˆç‰¹å®šçš„ JSON ç»“æ„ï¼Œä»¥ä¾¿ç½‘å…³èƒ½å°†å…¶è½¬æ¢å› HTTP å“åº”ï¼ˆçŠ¶æ€ç ã€Headerã€Bodyï¼‰ï¼š

```javascript
function createResponse(statusCode, data) {
  return {
    isBase64Encoded: false,
    statusCode: statusCode,
    headers: {
      'Content-Type': 'application/json',
      // å…³é”®ï¼šå…è®¸è·¨åŸŸï¼Œå› ä¸ºå‰ç«¯åŸŸåå’Œ FC åŸŸåä¸ä¸€è‡´
      'access-control-allow-origin': '*', 
      'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
      'Access-Control-Allow-Headers': '*'
    },
    body: JSON.stringify(data) // Body å¿…é¡»æ˜¯å­—ç¬¦ä¸²
  };
}
```

> [!IMPORTANT]
> ä¸ä¸€å®šè¦å†™å…¥`'access-control-allow-origin': '*'`ï¼Œå› ä¸ºé˜¿é‡Œäº‘åœ¨å°è£…è¿”å›ç»“æœæ—¶ï¼Œå¯èƒ½ä¹Ÿå†™å…¥äº†`access-control-allow-origin`ï¼Œä¸¤ä¸ª`access-control-allow-origin`ä¼šå¯¼è‡´**CORSæ ¡éªŒå¤±è´¥**ï¼ˆå‚è€ƒ[3. ä»€ä¹ˆæ˜¯ CORS](030-è·¨åŸŸ.md#3.%20ä»€ä¹ˆæ˜¯%20CORS)ï¼‰

### 4.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

åç«¯è„šæœ¬å…¶å®æ˜¯ä¸€ä¸ªç®€å•çš„**é€»è¾‘è·¯ç”±**ï¼š

1.  **é‰´æƒ**ï¼šæ£€æŸ¥ `body.password === process.env.ACCESS_PASSWORD`ã€‚
2.  **åˆ†æ”¯å¤„ç†**ï¼š
    *   **Action: list** -> è°ƒç”¨ GitHub Tree API (`GET /repos/.../git/trees/main?recursive=1`)ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„ APIï¼Œèƒ½ä¸€æ¬¡æ€§æ‹‰å–æ•´ä¸ªä»“åº“çš„ç›®å½•ç»“æ„ã€‚
    *   **Action: content** -> è°ƒç”¨ GitHub Contents API (`GET /repos/.../contents/{path}`)ã€‚
3.  **GitHub è°ƒç”¨**ï¼šä½¿ç”¨ Node.js åŸç”Ÿ `https` æ¨¡å—ï¼ŒHeader ä¸­å¿…é¡»æºå¸¦ `Authorization: token <GITHUB_TOKEN>`ã€‚

## 5. éƒ¨ç½²é…ç½®æ¸…å•

è¦æˆåŠŸè¿è¡Œæ­¤æœåŠ¡ï¼Œéœ€è¦åœ¨[é˜¿é‡Œäº‘æ§åˆ¶å°](https://fcnext.console.aliyun.com/)è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š

**åˆ›å»ºæœåŠ¡ä¸å‡½æ•°**ï¼š
- åŒºåŸŸï¼šé¦™æ¸¯ï¼ˆGitHub ä¸é¦™æ¸¯çš„ç½‘ç»œé€šä¿¡ä¸ä¼šè¢«å¢™ï¼Œä¸”é¦™æ¸¯åœ°åŒºç”³è¯· SSL è¯ä¹¦ä¸ç”¨å¤‡æ¡ˆï¼Œä»¥å¤‡åæœŸæ‰©å±•ï¼‰
- åˆ›å»ºWEBå‡½æ•°ï¼šè¿è¡Œç¯å¢ƒä¸ºå†…ç½®è¿è¡Œæ—¶ï¼ŒNode.js16

## 6. æ€»ç»“

é€šè¿‡è¿™ç§æ¶æ„ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š
1.  **ä½æˆæœ¬**ï¼šåˆ©ç”¨ Serverless çš„æŒ‰é‡ä»˜è´¹ç‰¹æ€§ï¼Œä¸ªäººåšå®¢è¿™ç§ä½é¢‘è®¿é—®å‡ ä¹å…è´¹ã€‚
2.  **å®‰å…¨æ€§**ï¼šGitHub Token æ°¸ä¸å‡ºåº“ï¼Œå‰ç«¯åªæš´éœ²ä½ä»·å€¼çš„è®¿é—®å¯†ç ã€‚
3.  **çµæ´»æ€§**ï¼šå‰ç«¯ä¿ç•™äº† VitePress çš„ä¼˜è‰¯ä½“éªŒï¼Œåç«¯é€šè¿‡ API åŠ¨æ€èµ‹èƒ½ã€‚

# é™„ä»£ç 

### å‰ç«¯ä»£ç 

```
<script setup lang="ts">

import { ref, watch, computed, onMounted } from 'vue'

import MarkdownIt from 'markdown-it'

import { privateStore, type PrivateFile } from '../store'

import FileTreeNode from './FileTreeNode.vue'

import { useRoute, useRouter } from 'vitepress'

  

const route = useRoute()

const router = useRouter()

  

const password = ref('')

const loading = ref(false)

const errorMsg = ref('')

const API_URL = 'https://privatege-proxy-uypbjhvwjb.cn-hongkong.fcapp.run/'

const sidebarWidth = ref(250)

const isResizing = ref(false)

const isSidebarCollapsed = ref(window.innerWidth < 768)

const sidebarRef = ref<HTMLElement | null>(null)

// æŒ‰é’®ä½ç½®çŠ¶æ€ (é»˜è®¤å‘ä¸‹åç§» 60px ä»¥é¿å¼€äºŒçº§å¯¼èˆª)

const btnPos = ref({ top: 60, left: 16 })

const isBtnDragging = ref(false)

const pendingAnchor = ref('') // å¾…è·³è½¬çš„é”šç‚¹

  

// æŒ‰é’®æ‹–æ‹½é€»è¾‘

function initBtnDrag(e: MouseEvent | TouchEvent) {

Â  // é˜»æ­¢é»˜è®¤æ»šåŠ¨ä¸é¼ æ ‡äº‹ä»¶é€ä¼  (ä¿®å¤ç§»åŠ¨ç«¯åŒé‡è§¦å‘é—®é¢˜)

Â  if (e.type === 'touchstart') {

Â  Â  e.preventDefault()

Â  }

  

Â  const startX = e instanceof MouseEvent ? e.clientX : e.touches[0].clientX

Â  const startY = e instanceof MouseEvent ? e.clientY : e.touches[0].clientY

Â  const startLeft = btnPos.value.left

Â  const startTop = btnPos.value.top

Â  let hasMoved = false

  

Â  const onMove = (moveEvent: MouseEvent | TouchEvent) => {

Â  Â  const clientX = moveEvent instanceof MouseEvent ? moveEvent.clientX : moveEvent.touches[0].clientX

Â  Â  const clientY = moveEvent instanceof MouseEvent ? moveEvent.clientY : moveEvent.touches[0].clientY

Â  Â  const deltaX = clientX - startX

Â  Â  const deltaY = clientY - startY

Â  Â  // æ”¾å®½åˆ¤å®šé˜ˆå€¼ï¼šåªæœ‰ç§»åŠ¨è¶…è¿‡ 5px æ‰ç®—æ‹–æ‹½

Â  Â  if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {

Â  Â  Â  hasMoved = true

Â  Â  Â  isBtnDragging.value = true

Â  Â  }

Â  Â  if (hasMoved) {

Â  Â  Â  moveEvent.preventDefault() // æ‹–æ‹½æ—¶é˜»æ­¢æ»šåŠ¨

Â  Â  Â  let newLeft = startLeft + deltaX

Â  Â  Â  let newTop = startTop + deltaY

Â  Â  Â  // è¾¹ç•Œé™åˆ¶

Â  Â  Â  const maxLeft = window.innerWidth - 40 // æŒ‰é’®å®½çº¦40

Â  Â  Â  const maxTop = window.innerHeight - 40

Â  Â  Â  if (newLeft < 0) newLeft = 0

Â  Â  Â  if (newLeft > maxLeft) newLeft = maxLeft

Â  Â  Â  if (newTop < 0) newTop = 0

Â  Â  Â  if (newTop > maxTop) newTop = maxTop

Â  Â  Â  btnPos.value = { left: newLeft, top: newTop }

Â  Â  }

Â  }

  

Â  const onUp = () => {

Â  Â  if (!hasMoved) {

Â  Â  Â  toggleSidebar()

Â  Â  }

Â  Â  isBtnDragging.value = false

Â  Â  window.removeEventListener('mousemove', onMove)

Â  Â  window.removeEventListener('mouseup', onUp)

Â  Â  window.removeEventListener('touchmove', onMove)

Â  Â  window.removeEventListener('touchend', onUp)

Â  }

  

Â  window.addEventListener('mousemove', onMove, { passive: false })

Â  window.addEventListener('mouseup', onUp)

Â  window.addEventListener('touchmove', onMove, { passive: false })

Â  window.addEventListener('touchend', onUp)

}

  

// ç›‘å¬çª—å£å¤§å°

window.addEventListener('resize', () => {

Â  // å¯é€‰ï¼šç§»åŠ¨ç«¯è‡ªåŠ¨æŠ˜å é€»è¾‘

})

  

function toggleSidebar() {

Â  isSidebarCollapsed.value = !isSidebarCollapsed.value

Â  if (sidebarRef.value) {

Â  Â  sidebarRef.value.style.width = ''

Â  }

Â  if (!isSidebarCollapsed.value && sidebarWidth.value < 150) {

Â  Â  sidebarWidth.value = 250

Â  }

}

  

// æ‹–æ‹½é€»è¾‘ (rAF ä¼˜åŒ–ç‰ˆï¼šå®æ—¶è·Ÿæ‰‹)

function initResize(e: MouseEvent) {

Â  if (isSidebarCollapsed.value) return

Â  isResizing.value = true

Â  document.body.classList.add('vp-resizing')

Â  document.body.style.cursor = 'col-resize'

Â  document.body.style.userSelect = 'none'

Â  const startX = e.clientX

Â  const startWidth = sidebarWidth.value

Â  const sidebarEl = sidebarRef.value

Â  let animationFrameId: number

  

Â  const onMouseMove = (moveEvent: MouseEvent) => {

Â  Â  if (animationFrameId) cancelAnimationFrame(animationFrameId)

Â  Â  animationFrameId = requestAnimationFrame(() => {

Â  Â  Â  const delta = moveEvent.clientX - startX

Â  Â  Â  let newWidth = startWidth + delta

Â  Â  Â  if (newWidth < 150) newWidth = 150

Â  Â  Â  if (newWidth > 500) newWidth = 500

Â  Â  Â  if (sidebarEl) {

Â  Â  Â  Â  sidebarEl.style.width = `${newWidth}px`

Â  Â  Â  }

Â  Â  })

Â  }

  

Â  const onMouseUp = (upEvent: MouseEvent) => {

Â  Â  isResizing.value = false

Â  Â  document.body.classList.remove('vp-resizing')

Â  Â  document.body.style.cursor = ''

Â  Â  document.body.style.userSelect = ''

Â  Â  if (animationFrameId) cancelAnimationFrame(animationFrameId)

Â  Â  const delta = upEvent.clientX - startX

Â  Â  let newWidth = startWidth + delta

Â  Â  if (newWidth < 150) newWidth = 150

Â  Â  if (newWidth > 500) newWidth = 500

Â  Â  sidebarWidth.value = newWidth

Â  Â  window.removeEventListener('mousemove', onMouseMove)

Â  Â  window.removeEventListener('mouseup', onMouseUp)

Â  }

  

Â  window.addEventListener('mousemove', onMouseMove)

Â  window.addEventListener('mouseup', onMouseUp)

}

  

// åˆå§‹åŒ– Markdown-it å®ä¾‹

const md = new MarkdownIt({

Â  html: true,

Â  linkify: true,

Â  typographer: true,

Â  highlight: function (str, lang) {

Â  Â  // @ts-ignore

Â  Â  if (lang && window.hljs) {

Â  Â  Â  try {

Â  Â  Â  Â  // @ts-ignore

Â  Â  Â  Â  return '<pre class="hljs"><code>' +

Â  Â  Â  Â  Â  Â  Â  Â // @ts-ignore

Â  Â  Â  Â  Â  Â  Â  Â window.hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +

Â  Â  Â  Â  Â  Â  Â  Â '</code></pre>';

Â  Â  Â  } catch (__) {}

Â  Â  }

Â  Â  return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';

Â  }

})

  

// ä¸ºæ ‡é¢˜æ·»åŠ  ID ä»¥æ”¯æŒé”šç‚¹è·³è½¬

md.renderer.rules.heading_open = (tokens, idx, options, env, self) => {

Â  const token = tokens[idx]

Â  // è·å–æ ‡é¢˜æ–‡æœ¬å†…å®¹ (ä¸‹ä¸€ä¸ª token æ˜¯ inline)

Â  const titleToken = tokens[idx + 1]

Â  let title = ''

Â  if (titleToken && titleToken.content) {

Â  Â  title = titleToken.content

Â  }

Â  // ç”Ÿæˆ ID: ç®€å•å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨æ–‡æœ¬ä½œä¸º ID (æ”¯æŒä¸­æ–‡)

Â  if (title) {

Â  Â  token.attrSet('id', title)

Â  }

Â  return self.renderToken(tokens, idx, options)

}

  

// åŠ¨æ€åŠ è½½ Highlight.js

function loadHighlight() {

Â  if (document.getElementById('hljs-script')) return

  

Â  const script = document.createElement('script')

Â  script.id = 'hljs-script'

Â  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'

Â  document.head.appendChild(script)

}

  

onMounted(() => {

Â  loadHighlight()

})

  

// Helper: Build Tree from Flat GitHub Paths

function buildFileTree(flatFiles: any[]): PrivateFile[] {

Â  const root: PrivateFile[] = []

Â  const map = new Map<string, PrivateFile>()

  

Â  flatFiles.forEach(f => {

Â  Â  const isDir = f.type === 'tree'

Â  Â  const node: PrivateFile = {

Â  Â  Â  name: f.path.split('/').pop() || '',

Â  Â  Â  path: f.path,

Â  Â  Â  type: isDir ? 'dir' : 'file',

Â  Â  Â  children: isDir ? [] : undefined

Â  Â  }

Â  Â  map.set(f.path, node)

Â  })

  

Â  flatFiles.forEach(f => {

Â  Â  const node = map.get(f.path)!

Â  Â  const parts = f.path.split('/')

Â  Â  if (parts.length === 1) {

Â  Â  Â  root.push(node)

Â  Â  } else {

Â  Â  Â  const parentPath = parts.slice(0, -1).join('/')

Â  Â  Â  const parent = map.get(parentPath)

Â  Â  Â  if (parent && parent.children) {

Â  Â  Â  Â  parent.children.push(node)

Â  Â  Â  } else {

Â  Â  Â  Â  root.push(node)

Â  Â  Â  }

Â  Â  }

Â  })

Â  const sortFn = (a: PrivateFile, b: PrivateFile) => {

Â  Â  if (a.type === b.type) return a.name.localeCompare(b.name)

Â  Â  return a.type === 'dir' ? -1 : 1

Â  }

Â  const sortRecursive = (nodes: PrivateFile[]) => {

Â  Â  nodes.sort(sortFn)

Â  Â  nodes.forEach(n => {

Â  Â  Â  if (n.children) sortRecursive(n.children)

Â  Â  })

Â  }

Â  sortRecursive(root)

  

Â  return root

}

  

// é€’å½’æŸ¥æ‰¾æ–‡ä»¶èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½®è·¯å¾„ä¸Šæ‰€æœ‰çˆ¶èŠ‚ç‚¹çš„ expanded = true

function findAndExpand(nodes: PrivateFile[], targetPath: string): PrivateFile | null {

Â  for (const node of nodes) {

Â  Â  // æ£€æŸ¥æ˜¯å¦åŒ¹é…ï¼šå…¨è·¯å¾„åŒ¹é… æˆ– åç¼€åŒ¹é…

Â  Â  if (node.type === 'file' && (node.path === targetPath || node.path.endsWith(targetPath))) {

Â  Â  Â  return node

Â  Â  }

Â  Â  if (node.type === 'dir' && node.children) {

Â  Â  Â  const found = findAndExpand(node.children, targetPath)

Â  Â  Â  if (found) {

Â  Â  Â  Â  // å¦‚æœå­èŠ‚ç‚¹è¢«æ‰¾åˆ°äº†ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯çˆ¶çº§è·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å±•å¼€

Â  Â  Â  Â  node.expanded = true

Â  Â  Â  Â  return found

Â  Â  Â  }

Â  Â  }

Â  }

Â  return null

}

  

async function unlock() {

Â  loading.value = true

Â  errorMsg.value = ''

Â  try {

Â  Â  const res = await fetch(API_URL, {

Â  Â  Â  method: 'POST',

Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  body: JSON.stringify({

Â  Â  Â  Â  password: password.value,

Â  Â  Â  Â  action: 'list'

Â  Â  Â  })

Â  Â  })

Â  Â  if (!res.ok) {

Â  Â  Â  Â throw new Error(`Server Error: ${res.status}`)

Â  Â  }

Â  Â  const data = await res.json()

Â  Â  const realData = data.data || data

Â  Â  if (realData.files) {

Â  Â  Â  const tree = buildFileTree(realData.files)

Â  Â  Â  privateStore.token = password.value

Â  Â  Â  privateStore.setData(tree)

Â  Â  Â  // å¤„ç†è‡ªåŠ¨è·³è½¬

Â  Â  Â  const targetPath = new URLSearchParams(window.location.search).get('target')

Â  Â  Â  if (targetPath) {

Â  Â  Â  Â  let rawPath = decodeURIComponent(targetPath)

Â  Â  Â  Â  // æå–é”šç‚¹

Â  Â  Â  Â  const hashMatch = rawPath.match(/#.+$/)

Â  Â  Â  Â  if (hashMatch) {

Â  Â  Â  Â  Â  pendingAnchor.value = hashMatch[0]

Â  Â  Â  Â  }

  

Â  Â  Â  Â  // 1. æå–æœ‰æ•ˆè·¯å¾„ï¼šæˆªå– '98-Private/' ä¹‹åçš„éƒ¨åˆ†

Â  Â  Â  Â  const keyword = '98-Private/'

Â  Â  Â  Â  let cleanPath = ''

Â  Â  Â  Â  const idx = rawPath.indexOf(keyword)

Â  Â  Â  Â  if (idx !== -1) {

Â  Â  Â  Â  Â  cleanPath = rawPath.substring(idx + keyword.length)

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  // ç§»é™¤æ‰€æœ‰ ../ å’Œ ./

Â  Â  Â  Â  Â  cleanPath = rawPath.replace(/^(\.\.\/)+/, '').replace(/^(\.\/)+/, '')

Â  Â  Â  Â  }

  

Â  Â  Â  Â  // 1.5 ç§»é™¤ URL é”šç‚¹

Â  Â  Â  Â  cleanPath = cleanPath.split('#')[0]

  

Â  Â  Â  Â  // 2. ä¿®æ­£æ‰©å±•å

Â  Â  Â  Â  cleanPath = cleanPath.replace(/\.html$/, '.md')

  

Â  Â  Â  Â  console.log('[Debug] åŸå§‹Target:', targetPath)

Â  Â  Â  Â  console.log('[Debug] ä¿®æ­£åPath:', cleanPath)

Â  Â  Â  Â  console.log('[Debug] é”šç‚¹:', pendingAnchor.value)

  

Â  Â  Â  Â  // é€’å½’æŸ¥æ‰¾å¹¶å±•å¼€

Â  Â  Â  Â  const foundNode = findAndExpand(privateStore.fileList, cleanPath)

Â  Â  Â  Â  console.log('[Debug] æŸ¥æ‰¾ç»“æœ:', foundNode)

Â  Â  Â  Â  if (foundNode) {

Â  Â  Â  Â  Â  await selectFile(foundNode)

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  } else {

Â  Â  Â  throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸å¯¹ï¼Œæ‰¾ä¸åˆ° files å­—æ®µ')

Â  Â  }

Â  } catch (e: any) {

Â  Â  errorMsg.value = e.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥'

Â  } finally {

Â  Â  loading.value = false

Â  }

}

  

async function selectFile(file: PrivateFile) {

Â  if (file.type === 'dir') return

Â  privateStore.currentDoc = file

Â  if (!file.content) {

Â  Â  try {

Â  Â  Â  const res = await fetch(API_URL, {

Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  body: JSON.stringify({

Â  Â  Â  Â  Â  password: privateStore.token,

Â  Â  Â  Â  Â  action: 'content',

Â  Â  Â  Â  Â  path: file.path

Â  Â  Â  Â  })

Â  Â  Â  })

Â  Â  Â  const data = await res.json()

Â  Â  Â  if (data.error) throw new Error(data.error)

Â  Â  Â  const contentBase64 = data.content.replace(/\s/g, '')

Â  Â  Â  const binaryString = window.atob(contentBase64)

Â  Â  Â  const bytes = new Uint8Array(binaryString.length)

Â  Â  Â  for (let i = 0; i < binaryString.length; i++) {

Â  Â  Â  Â  bytes[i] = binaryString.charCodeAt(i)

Â  Â  Â  }

Â  Â  Â  const decoder = new TextDecoder('utf-8')

Â  Â  Â  file.content = decoder.decode(bytes)

Â  Â  } catch (e) {

Â  Â  Â  console.error(e)

Â  Â  Â  file.content = '> âŒ Error loading content'

Â  Â  }

Â  }

}

  

const renderedContent = computed(() => {

Â  if (!privateStore.currentDoc) return ''

Â  if (privateStore.currentDoc.content === undefined) return '*(Loading...)*'

Â  const raw = privateStore.currentDoc.content || ''

Â  const cleanContent = raw.replace(/^---[\s\S]*?---\n/, '')

Â  return md.render(cleanContent)

})

  

// ç›‘å¬å†…å®¹æ¸²æŸ“å®Œæˆï¼Œå¤„ç†é”šç‚¹è·³è½¬

watch(renderedContent, () => {

Â  if (pendingAnchor.value) {

Â  Â  // ç»™äºˆ Markdown æ¸²æŸ“å’Œ DOM æ›´æ–°ä¸€ç‚¹æ—¶é—´

Â  Â  setTimeout(() => {

Â  Â  Â  let selector = pendingAnchor.value

Â  Â  Â  try {

Â  Â  Â  Â  Â const id = decodeURIComponent(selector.replace(/^#/, ''))

Â  Â  Â  Â  Â const el = document.getElementById(id)

Â  Â  Â  Â  Â if (el) {

Â  Â  Â  Â  Â  Â el.scrollIntoView({ behavior: 'smooth' })

Â  Â  Â  Â  Â  Â pendingAnchor.value = '' // æ¸…é™¤çŠ¶æ€

Â  Â  Â  Â  Â } else {

Â  Â  Â  Â  Â  Â  console.warn('[PrivateVault] Anchor not found:', id)

Â  Â  Â  Â  Â }

Â  Â  Â  } catch (e) {

Â  Â  Â  Â  console.error(e)

Â  Â  Â  }

Â  Â  }, 300) // 300ms å»¶è¿Ÿç¡®ä¿ DOM æŒ‚è½½

Â  }

})

</script>

  

<template>

Â  <div class="vault-wrapper">

Â  Â  <!-- State 1: Locked -->

Â  Â  <div v-if="!privateStore.isUnlocked" class="lock-screen">

Â  Â  Â  <div class="lock-card">

Â  Â  Â  Â  <div class="icon-lock">ğŸ”</div>

Â  Â  Â  Â  <h2>ç§æœ‰ä¿é™©ç®±</h2>

Â  Â  Â  Â  <p class="subtext">è¿æ¥è‡³ Private Cloud</p>

Â  Â  Â  Â  <div class="input-box">

Â  Â  Â  Â  Â  <input

Â  Â  Â  Â  Â  Â  type="password"

Â  Â  Â  Â  Â  Â  v-model="password"

Â  Â  Â  Â  Â  Â  placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ..."

Â  Â  Â  Â  Â  Â  @keyup.enter="unlock"

Â  Â  Â  Â  Â  />

Â  Â  Â  Â  Â  <button @click="unlock" :disabled="loading">

Â  Â  Â  Â  Â  Â  {{ loading ? 'è¿æ¥ä¸­...' : 'è§£é”' }}

Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div v-if="errorMsg" class="error-msg">{{ errorMsg }}</div>

Â  Â  Â  </div>

Â  Â  </div>

  

Â  Â  <!-- State 2: Unlocked -->

Â  Â  <div v-else class="vault-ui" :class="{ 'sidebar-collapsed': isSidebarCollapsed }">

Â  Â  Â  <!-- Toggle Button (Draggable) -->

Â  Â  Â  <button

Â  Â  Â  Â  class="mobile-sidebar-toggle"

Â  Â  Â  Â  :style="{ top: btnPos.top + 'px', left: btnPos.left + 'px', cursor: isBtnDragging ? 'grabbing' : 'pointer' }"

Â  Â  Â  Â  @mousedown="initBtnDrag"

Â  Â  Â  Â  @touchstart="initBtnDrag"

Â  Â  Â  Â  title="åˆ‡æ¢æ–‡ä»¶åˆ—è¡¨ (å¯æ‹–åŠ¨)"

Â  Â  Â  >

Â  Â  Â  Â  <span class="icon">ğŸ“‚</span>

Â  Â  Â  </button>

  

Â  Â  Â  <!-- Sidebar -->

Â  Â  Â  <div class="vault-sidebar"

Â  Â  Â  Â  Â  Â ref="sidebarRef"

Â  Â  Â  Â  Â  Â :style="{ width: isSidebarCollapsed ? '0px' : sidebarWidth + 'px' }">

Â  Â  Â  Â  <div class="vault-header">

Â  Â  Â  Â  Â  <span class="vault-title">ğŸ“¦ è¿œç¨‹æ–‡ä»¶åº“</span>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="file-tree">

Â  Â  Â  Â  Â  Â <FileTreeNode

Â  Â  Â  Â  Â  Â  Â v-for="node in privateStore.fileList"

Â  Â  Â  Â  Â  Â  Â :key="node.path"

Â  Â  Â  Â  Â  Â  Â :node="node"

Â  Â  Â  Â  Â  Â  Â :currentPath="privateStore.currentDoc?.path"

Â  Â  Â  Â  Â  Â  Â @select="selectFile"

Â  Â  Â  Â  Â  Â />

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

  

Â  Â  Â  <!-- Resizer Handle (Always visible to allow expanding) -->

Â  Â  Â  <div class="vault-resizer" @mousedown="initResize"></div>

  

Â  Â  Â  <!-- Content -->

Â  Â  Â  <div class="vault-content">

Â  Â  Â  Â  <div v-if="privateStore.currentDoc" class="vp-doc">

Â  Â  Â  Â  Â  Â <div v-html="renderedContent"></div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div v-else class="empty-state">

Â  Â  Â  Â  Â  <div class="empty-icon">ğŸ‘‹</div>

Â  Â  Â  Â  Â  <h3>å·²å®‰å…¨è¿æ¥</h3>

Â  Â  Â  Â  Â  <p>ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶ä»¥ä» GitHub ç§æœ‰ä»“åº“åŠ è½½å†…å®¹</p>

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

  

Â  Â  </div>

  

Â  </div>

</template>

  

<style scoped>

.vault-wrapper {

Â  /* Fixed positioning to fill the remaining area */

Â  position: fixed;

Â  top: var(--vp-nav-height);

Â  right: 0;

Â  bottom: 0;

Â  /* Start after the sidebar */

Â  left: var(--vp-sidebar-width, 0);

Â  width: calc(100vw - var(--vp-sidebar-width, 0));

Â  /* ã€ä¿®æ”¹ç‚¹ 2ã€‘ï¼šæå‡å±‚çº§ */

Â  /* VitePress çš„ LocalNav å±‚çº§é€šå¸¸æ˜¯ 20ï¼Œæˆ‘ä»¬å°†è¿™é‡Œæå‡åˆ° 30 ä»¥è¦†ç›–å®ƒ */

Â  z-index: 30;

Â  background: var(--vp-c-bg);

Â  border-top: 1px solid var(--vp-c-divider);

Â  border-left: 1px solid var(--vp-c-divider);

Â  border-radius: 0;

Â  overflow: hidden;

Â  display: flex;

Â  flex-direction: column;

}

  

/* On mobile, the sidebar is usually hidden or overlayed, so we take full width */

@media (max-width: 959px) {

Â  .vault-wrapper {

Â  Â  left: 0;

Â  Â  width: 100vw;

Â  Â  border-left: none;

Â  Â  /* åŒæ ·ä½¿ç”¨æ ‡å‡†å¯¼èˆªæ é«˜åº¦ */

Â  Â  top: var(--vp-nav-height);

Â  Â  height: calc(100vh - var(--vp-nav-height));

Â  }

}

  

.lock-screen {

Â  flex: 1;

Â  display: flex;

Â  align-items: center;

Â  justify-content: center;

Â  background: var(--vp-c-bg);

}

.lock-card {

Â  text-align: center;

Â  padding: 40px;

Â  background: var(--vp-c-bg);

Â  border-radius: 12px;

Â  border: 1px solid var(--vp-c-divider);

Â  box-shadow: 0 4px 24px rgba(0,0,0,0.05);

Â  width: 100%;

Â  max-width: 400px;

}

.icon-lock { font-size: 48px; margin-bottom: 16px; }

.lock-card h2 { margin: 0 0 8px; font-weight: 600; }

.subtext { color: var(--vp-c-text-2); margin-bottom: 24px; font-size: 14px; }

.input-box { display: flex; gap: 8px; }

.input-box input {

Â  flex: 1;

Â  padding: 8px 12px;

Â  border: 1px solid var(--vp-c-divider);

Â  border-radius: 6px;

Â  background: var(--vp-c-bg);

}

.input-box button {

Â  padding: 8px 16px;

Â  background: var(--vp-c-brand);

Â  color: white;

Â  border-radius: 6px;

Â  font-weight: 600;

Â  cursor: pointer;

}

.error-msg { color: var(--vp-c-danger); margin-top: 12px; font-size: 13px; }

  

.vault-ui {

Â  display: flex;

Â  height: 100%;

Â  position: relative;

}

  

.vault-sidebar {

Â  border-right: 1px solid var(--vp-c-divider);

Â  background: var(--vp-c-bg);

Â  display: flex;

Â  flex-direction: column;

Â  overflow-y: auto;

Â  flex-shrink: 0;

Â  transition: width 0.3s ease, transform 0.3s ease;

Â  overflow-x: hidden;

}

  

/* æ‹–æ‹½æ—¶ç¦ç”¨è¿‡æ¸¡ï¼Œæ¶ˆé™¤æ»åæ„Ÿ */

:global(body.vp-resizing) .vault-sidebar {

Â  transition: none !important;

}

  

/* åˆ‡æ¢æŒ‰é’® (å·¦ä¸Šè§’) */

.mobile-sidebar-toggle {

Â  position: absolute;

Â  top: 12px;

Â  left: 12px;

Â  /* ã€ä¿®æ”¹ç‚¹ 4ã€‘ï¼šç¡®ä¿æŒ‰é’®å±‚çº§æœ€é«˜ */

Â  z-index: 100;

Â  background: var(--vp-c-bg);

Â  border: 1px solid var(--vp-c-divider);

Â  border-radius: 4px;

Â  padding: 6px 10px;

Â  cursor: pointer;

Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);

Â  transition: background 0.2s, box-shadow 0.2s;

}

.sidebar-collapsed .mobile-sidebar-toggle {

Â  background: var(--vp-c-bg-alt);

}

  

/* æ‹–æ‹½æ‰‹æŸ„æ ·å¼ */

.vault-resizer {

Â  width: 1px; /* é»˜è®¤ä¸ºä¸€æ¡ç»†çº¿ */

Â  background: var(--vp-c-divider);

Â  cursor: col-resize;

Â  position: relative;

Â  z-index: 10;

Â  flex-shrink: 0;

Â  transition: background 0.2s, width 0.2s;

}

  

/* å¢åŠ éšå½¢çƒ­åŒº */

.vault-resizer::after {

Â  content: '';

Â  position: absolute;

Â  top: 0;

Â  bottom: 0;

Â  left: -6px;

Â  right: -6px;

Â  z-index: 20;

}

  

.vault-resizer:hover,

.vault-resizer:active {

Â  background: var(--vp-c-brand);

Â  width: 4px; /* æ¿€æ´»æ—¶å˜å®½ */

}

  

.vault-header {

Â  padding: 16px;

Â  padding-left: 50px; /* ç»™ toggle æŒ‰é’®ç•™å‡ºç©ºé—´ */

Â  /* ã€ä¿®æ”¹ç‚¹ 3ã€‘ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è· */

Â  padding-top: 24px;

Â  border-bottom: 1px solid var(--vp-c-divider);

Â  font-weight: 600;

Â  color: var(--vp-c-text-1);

}

.file-tree { padding: 8px; }

.tree-group { margin-bottom: 4px; }

  

.tree-folder-label {

Â  display: flex;

Â  align-items: center;

Â  padding: 8px;

Â  font-size: 13px;

Â  font-weight: 700;

Â  color: var(--vp-c-text-2);

Â  text-transform: uppercase;

}

  

.tree-children {

Â  padding-left: 16px;

}

  

.tree-item {

Â  display: flex;

Â  align-items: center;

Â  padding: 6px 8px;

Â  margin-left: 4px;

Â  font-size: 14px;

Â  color: var(--vp-c-text-1);

Â  cursor: pointer;

Â  border-radius: 4px;

Â  white-space: nowrap;

Â  overflow: hidden;

Â  text-overflow: ellipsis;

}

  

.tree-item .icon {

Â  margin-right: 6px;

}

  

.tree-folder-label .icon {

Â  margin-right: 6px;

}

  

.tree-item:hover {

Â  background: var(--vp-c-bg-mute);

}

  

.tree-item.active {

Â  background: var(--vp-c-brand-dimm);

Â  color: var(--vp-c-brand);

Â  font-weight: 600;

}

  

.vault-content {

Â  flex: 1;

Â  overflow-y: auto;

Â  padding: 24px 40px;

Â  padding-top: 50px; /* ç»™æŒ‰é’®ç•™å‡ºç©ºé—´ */

Â  background: var(--vp-c-bg);

}

.empty-state {

Â  height: 100%;

Â  display: flex;

Â  flex-direction: column;

Â  align-items: center;

Â  justify-content: center;

Â  color: var(--vp-c-text-2);

}

.empty-icon { font-size: 48px; margin-bottom: 16px; }

  

/* ç§»åŠ¨ç«¯é€‚é…é€»è¾‘ */

@media (max-width: 768px) {

Â  .vault-sidebar {

Â  Â  position: absolute;

Â  Â  top: 0;

Â  Â  left: 0;

Â  Â  bottom: 0;

Â  Â  width: 80% !important;

Â  Â  max-width: 300px;

Â  Â  z-index: 15;

Â  Â  box-shadow: 4px 0 16px rgba(0,0,0,0.1);

Â  Â  transform: translateX(0); /* é»˜è®¤æ˜¾ç¤º */

Â  }

Â  /* æŠ˜å æ—¶ç§»å‡ºå±å¹• */

Â  .vault-ui.sidebar-collapsed .vault-sidebar {

Â  Â  transform: translateX(-100%);

Â  Â  width: 80% !important;

Â  Â  border-right: none;

Â  }

Â  /* é®ç½©å±‚ */

Â  .vault-ui::before {

Â  Â  content: '';

Â  Â  position: absolute;

Â  Â  inset: 0;

Â  Â  background: rgba(0,0,0,0.3);

Â  Â  z-index: 14;

Â  Â  opacity: 0;

Â  Â  pointer-events: none;

Â  Â  transition: opacity 0.3s;

Â  }

Â  .vault-ui:not(.sidebar-collapsed)::before {

Â  Â  opacity: 1;

Â  Â  pointer-events: auto;

Â  }

Â  .vault-resizer {

Â  Â  display: none;

Â  }

}

  

/* === Syntax Highlighting Theme (VitePress-like) === */

.vp-doc :deep(.hljs) {

Â  background: var(--vp-c-bg-alt);

Â  color: var(--vp-c-text-1);

Â  padding: 20px 24px;

Â  margin: 16px 0;

Â  border-radius: 8px;

Â  overflow-x: auto;

Â  font-family: var(--vp-font-family-mono);

Â  font-size: 14px;

Â  line-height: 1.5;

}

  

.vp-doc :deep(.hljs-keyword), .vp-doc :deep(.hljs-function) { color: var(--vp-c-brand-1); font-weight: 600; }

.vp-doc :deep(.hljs-string) { color: #10b981; }

.vp-doc :deep(.hljs-comment) { color: var(--vp-c-text-3); font-style: italic; }

.vp-doc :deep(.hljs-number), .vp-doc :deep(.hljs-literal) { color: #f59e0b; }

.vp-doc :deep(.hljs-title) { color: #3b82f6; }

  

/* 3. é’ˆå¯¹ç‰¹å®šçš„é¡µé¢ç±» */

.vp-doc {

Â  max-width: 100% !important;

}

</style>
```


### FCä»£ç 

``` js
const https = require('https');

  

// --- 1. é…ç½®ä¿¡æ¯ ---

const GITHUB_OWNER = 'lysssyo';

const GITHUB_REPO = 'private-knowledge-base';

const GITHUB_BRANCH = 'main';

  

exports.handler = (event, context, callback) => {

Â  console.log('--- ğŸš€ æ–°è¯·æ±‚è¿›æ¥ (Eventæ¨¡å¼) ---');

  

Â  // 1. è§£æ Event å¯¹è±¡

Â  let eventObj = {};

Â  try {

Â  Â  eventObj = JSON.parse(event.toString()); Â  Â 

Â  Â  console.log('è·å–åˆ°çš„event:', JSON.stringify(eventObj, null, 2));

Â  } catch (e) {

Â  Â  console.error('âŒ Event è§£æå¤±è´¥:', e);

Â  Â  return callback(null, createResponse(400, { error: 'Invalid Event Format' }));

Â  }

  

Â  // 2. è¯†åˆ«è¯·æ±‚æ–¹æ³• (å…¼å®¹ FC 3.0 HTTP Trigger çš„å°è£…ç»“æ„)

Â  // ä¹Ÿå°±æ˜¯ä½ æ—¥å¿—é‡Œçœ‹åˆ°çš„ requestContext.http.method

Â  const method = eventObj.requestContext?.http?.method;

Â  console.log(`â„¹ï¸ è¯·æ±‚æ–¹æ³•: ${method}`);

  

Â  // 3. å¤„ç† CORS é¢„æ£€è¯·æ±‚ (OPTIONS)

Â  if (method === 'OPTIONS') {

Â  Â  console.log('âœ… å“åº” OPTIONS é¢„æ£€');

Â  Â  return callback(null, createResponse(200, {}));

Â  }

  

Â  // 4. è·å–å¹¶è§£æ Body

Â  // FC æœ‰æ—¶ä¼šå¯¹ Body è¿›è¡Œ Base64 ç¼–ç ï¼Œéœ€è¦æ£€æµ‹å¹¶è§£ç 

Â  let rawBody = eventObj.body;

Â  if (eventObj.isBase64Encoded && rawBody) {

Â  Â  rawBody = Buffer.from(rawBody, 'base64').toString();

Â  }

  

Â  // 5. è¿›å…¥æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

Â  processLogic(rawBody, (code, data) => {

Â  Â  callback(null, createResponse(code, data));

Â  });

};

  

// ==========================================

// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

// ==========================================

function processLogic(bodyStr, done) {

Â  let body = {};

Â  try {

Â  Â  body = JSON.parse(bodyStr || '{}');

Â  } catch (e) {

Â  Â  console.error('âŒ Body JSON è§£æå¤±è´¥:', e);

Â  Â  return done(400, { error: 'JSON Parse Error' });

Â  }

  

Â  // ç®€å•é‰´æƒ

Â  if (body.password !== process.env.ACCESS_PASSWORD) {

Â  Â  console.warn('â›” å¯†ç é”™è¯¯');

Â  Â  return done(401, { error: 'å¯†ç é”™è¯¯' });

Â  }

  

Â  const action = body.action;

Â  console.log(`ğŸ”§ æ‰§è¡Œæ“ä½œ: ${action}`);

  

Â  if (action === 'list') {

Â  Â  const apiPath = `/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/trees/${GITHUB_BRANCH}?recursive=1`;

Â  Â  callGitHub(apiPath, (data) => {

Â  Â  Â  Â if (data.message === 'Not Found') return done(404, { error: 'ä»“åº“æœªæ‰¾åˆ°' });

Â  Â  Â  Â // è¿‡æ»¤åªæ˜¾ç¤º .md æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹

Â  Â  Â  Â const tree = data.tree ? data.tree.filter(item => item.path.endsWith('.md') || item.type === 'tree') : [];

Â  Â  Â  Â console.log(`ğŸ“‚ è·å–æ–‡ä»¶åˆ—è¡¨æˆåŠŸï¼Œå…± ${tree.length} é¡¹`);

Â  Â  Â  Â done(200, { files: tree });

Â  Â  });

Â  } else if (action === 'content') {

Â  Â  const filePath = body.path || '';

Â  Â  if (!filePath) return done(400, { error: 'ç¼ºå°‘ path' });

Â  Â  const apiPath = `/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(filePath)}`;

Â  Â  callGitHub(apiPath, (data) => {

Â  Â  Â  Â if (data.message === 'Not Found') return done(404, { error: 'æ–‡ä»¶ä¸å­˜åœ¨' });

Â  Â  Â  Â console.log('ğŸ“„ è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ');

Â  Â  Â  Â done(200, { content: data.content });

Â  Â  });

Â  } else {

Â  Â  done(400, { error: 'æœªçŸ¥æ“ä½œ' });

Â  }

}

  

// ==========================================

// è¾…åŠ©å·¥å…·

// ==========================================

  

// ç»Ÿä¸€å°è£…å“åº”æ ¼å¼ (ç¬¦åˆé˜¿é‡Œäº‘ API ç½‘å…³/HTTP Trigger è¦æ±‚)

function createResponse(statusCode, bodyJson) {

Â  return {

Â  Â  isBase64Encoded: false,

Â  Â  statusCode: statusCode,

Â  Â  headers: {

Â  Â  Â  'Content-Type': 'application/json', Â 

Â  Â  Â  'access-control-allow-origin': '*', Â  Â 

Â  Â  Â  'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',

Â  Â  Â  'Access-Control-Allow-Headers': 'Content-Type, Authorization, Accept, X-Requested-With'

Â  Â  },

Â  Â  body: JSON.stringify(bodyJson)

Â  };

}

  

// è°ƒç”¨ GitHub API

function callGitHub(path, callback) {

Â  const options = {

Â  Â  hostname: 'api.github.com',

Â  Â  path: path,

Â  Â  method: 'GET',

Â  Â  headers: {

Â  Â  Â  'User-Agent': 'AliyunFC-Proxy',

Â  Â  Â  'Authorization': `token ${process.env.GITHUB_TOKEN}`,

Â  Â  Â  'Accept': 'application/vnd.github.v3+json'

Â  Â  }

Â  };

Â  const req = https.request(options, (res) => {

Â  Â  let data = '';

Â  Â  res.on('data', chunk => { data += chunk; });

Â  Â  res.on('end', () => {

Â  Â  Â  try {

Â  Â  Â  Â  callback(JSON.parse(data));

Â  Â  Â  } catch (e) {

Â  Â  Â  Â  callback({ error: 'GitHub Response Parse Error' });

Â  Â  Â  }

Â  Â  });

Â  });

Â  req.on('error', (e) => {

Â  Â  console.error('GitHub Request Error:', e);

Â  Â  callback({ error: e.message });

Â  });

Â  req.end();

}
```

### Event ç»“æ„

```
{  
Â Â Â Â "version":Â "v1",  
Â Â Â Â "rawPath":Â "/",  
Â Â Â Â "headers":Â {  
Â Â Â Â Â Â Â Â "Accept":Â "*/*",  
Â Â Â Â Â Â Â Â "Sec-Fetch-Site":Â "cross-site",  
Â Â Â Â Â Â Â Â "X-Forwarded-Proto":Â "[https](https://www.json.cn/jsononline/https)",  
Â Â Â Â Â Â Â Â "Referer":Â "[https://lysssyo.github.io/](https://lysssyo.github.io/)",  
Â Â Â Â Â Â Â Â "Sec-Ch-Ua-Mobile":Â "?0",  
Â Â Â Â Â Â Â Â "Sec-Fetch-Mode":Â "cors",  
Â Â Â Â Â Â Â Â "Sec-Ch-Ua-Platform":Â "\"Windows\"",  
Â Â Â Â Â Â Â Â "Connection":Â "keep-alive",  
Â Â Â Â Â Â Â Â "Host":Â "privatege-proxy-uypbjhvwjb.cn-hongkong.fcapp.run,privatege-proxy-uypbjhvwjb.cn-hongkong.fcapp.run",  
Â Â Â Â Â Â Â Â "Origin":Â "[https://lysssyo.github.io](https://lysssyo.github.io/)",  
Â Â Â Â Â Â Â Â "Accept-Encoding":Â "gzip,Â deflate,Â br,Â zstd",  
Â Â Â Â Â Â Â Â "Accept-Language":Â "zh-CN,zh;q=0.9,en-GB;q=0.8,en-US;q=0.7,en;q=0.6",  
Â Â Â Â Â Â Â Â "Sec-Ch-Ua":Â "\"GoogleÂ Chrome\";v=\"143\",Â \"Chromium\";v=\"143\",Â \"NotÂ A(Brand\";v=\"24\"",  
Â Â Â Â Â Â Â Â "Content-Length":Â "43",  
Â Â Â Â Â Â Â Â "Sec-Fetch-Dest":Â "empty",  
Â Â Â Â Â Â Â Â "Content-Type":Â "application/json",  
Â Â Â Â Â Â Â Â "User-Agent":Â "Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/143.0.0.0Â Safari/537.36"  
Â Â Â Â },  
Â Â Â Â "queryParameters":Â {  
  
Â Â Â Â },  
Â Â Â Â "body":Â "{\"password\":\"he1765A60260\",\"action\":\"list\"}",  
Â Â Â Â "isBase64Encoded":Â false,  
Â Â Â Â "requestContext":Â {  
Â Â Â Â Â Â Â Â "accountId":Â "1400907468986719",  
Â Â Â Â Â Â Â Â "domainName":Â "privatege-proxy-uypbjhvwjb.cn-hongkong.fcapp.run",  
Â Â Â Â Â Â Â Â "domainPrefix":Â "privatege-proxy-uypbjhvwjb",  
Â Â Â Â Â Â Â Â "requestId":Â "1-696f3235-14f858-ffa88a1a35af",  
Â Â Â Â Â Â Â Â "time":Â "2026-01-20T07:43:49.148834552+00:00",  
Â Â Â Â Â Â Â Â "timeEpoch":Â "1768895029148",  
Â Â Â Â Â Â Â Â "http":Â {  
Â Â Â Â Â Â Â Â Â Â Â Â "method":Â "POST",  
Â Â Â Â Â Â Â Â Â Â Â Â "path":Â "/",  
Â Â Â Â Â Â Â Â Â Â Â Â "protocol":Â "HTTP/1.1",  
Â Â Â Â Â Â Â Â Â Â Â Â "sourceIp":Â "103.172.183.87",  
Â Â Â Â Â Â Â Â Â Â Â Â "userAgent":Â "Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/143.0.0.0Â Safari/537.36"  
Â Â Â Â Â Â Â Â }  
Â Â Â Â }  
}
```