# ClickHouse 变更操作详解：UPDATE 与 DELETE

> [!IMPORTANT]
> **设计哲学**：在 ClickHouse 的架构设计中，数据被视为不可变的流。正如业内所言：“数据是用来分析的，不是用来反复横跳的。” 

---

## 1. 理解 ClickHouse 的写入特性

ClickHouse 采用 **LSM-Tree** 架构，数据按列高度压缩并存储在不可变的 **Data Part**（数据分区）中。

### 1.1 为什么传统的行级操作极其昂贵？
*   **列式存储**：修改单行中的某一列，物理上需要解压整个压缩块（Block）。
*   **物理偏移**：改变数据长度会导致索引文件和标记文件的偏移量全线失效。
*   **写放大**：行级修改的开销往往超过了重新写入整个分区的代价。

---

## 2. UPDATE 策略

### 2.1 突变操作 (Mutation)：`ALTER TABLE ... UPDATE`

这是 ClickHouse 提供的物理修改手段，但其行为与传统数据库迥异。

*   **异步机制**：提交指令后立即返回，任务在后台执行。可以通过 `system.mutations` 表监控进度。
*   **重写成本**：ClickHouse 会定位包含目标的 Data Part，读取原始数据并在内存修改后，**重写整个 Part**。
*   **性能警告**：
    *   即使只更新 1 行，也会导致全列文件的重写。
    *   **禁忌**：严禁高频执行该操作（如每秒数百次），否则会导致磁盘 I/O 溢出甚至集群宕机。

### 2.2 推荐方案：ReplacingMergeTree (以插代改)

这是 OLAP 场景下的主流实践，核心思想是**版本覆盖**。

*   **实现方式**：
    1.  建表时指定 `ReplacingMergeTree(ver)`。
    2.  **INSERT** 一条主键相同但 `ver`（版本号或时间戳）更大的新数据。
*   **底层原理**：后台 **Merge**（合并）进程会自动识别重复主键，并根据版本号丢弃旧行，保留最新行。

#### 如何确保查询结果的实时准确性？

由于后台合并是异步的，查询时需手动处理“未合并”的重复数据：

| 方法 | 语法 | 特点 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **FINAL 关键字** | `SELECT ... FROM table FINAL` | 实时合并，结果绝对准确 | 报表展现、小规模表查询 |
| **argMax 函数** | `SELECT id, argMax(col, ver) FROM table GROUP BY id` | 逻辑去重，性能最优 | 亿级以上超大规模表 |

---

## 3. DELETE 策略

根据业务容忍度和性能要求，ClickHouse 提供了三种递进的删除机制：

### 3.1 突变删除 (Mutation)：`ALTER TABLE ... DELETE`

*   **底层**：拷贝-过滤-重写 Part。
*   **特点**：彻底从磁盘抹除。
*   **适用场景**：极低频、合规性删除（如 GDPR 清洗某用户全部数据）。

### 3.2 轻量级删除 (Lightweight Delete)：`DELETE FROM`

*   **底层**：不重写数据，而是生成 `_row_exists` 掩码文件（Bitmap）。
*   **特点**：写入极快，查询时自动过滤。物理清理推迟到后续的 Merge 阶段。
*   **适用场景**：中等频率的业务删除。

### 3.3 逻辑删除 (推荐)：标记位设计

*   **底层**：在 `ReplacingMergeTree` 基础上增加 `is_deleted` (UInt8) 列。
*   **操作**：`INSERT` 标记位为 1 的新版本数据。
*   **优势**：
    *   完全避免物理删除带来的 I/O 震荡。
    *   可回溯，支持“撤销删除”。
    *   配合 `TTL` 或 `TTL ... DELETE WHERE is_deleted=1` 可实现自动物理清理。

---

## 总结与决策建议

1.  **高频更新/删除**：必须使用 `ReplacingMergeTree` + 逻辑标记位。
2.  **偶尔修正**：可使用 `DELETE FROM`（轻量级删除）。
3.  **周期性清理**：使用 `DROP PARTITION` 或 `TTL`（性能最高）。
4.  **永远不要**：试图用 ClickHouse 承载点对点的事务性更新业务。